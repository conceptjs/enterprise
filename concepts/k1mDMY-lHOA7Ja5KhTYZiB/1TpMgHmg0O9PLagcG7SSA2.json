{
  "uri" : "local://1TpMgHmg0O9PLagcG7SSA2/",
  "name" : "Study Creation Tool",
  "category" : "",
  "parent" : "local://k1mDMY-lHOA7Ja5KhTYZiB/",
  "flags" : "U",
  "lvars" : [ ],
  "vars" : [ {
    "name" : "htmlTemplate",
    "expr" : {
      "str" : "<html>\n    <head>\n        <link rel=\"stylesheet\" href=\"/resourcelocal://80AQTVfK4RARkqdz-caWt9/\">\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"//cdn.datatables.net/1.10.0/css/jquery.dataTables.css\">\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"//cdn.datatables.net/tabletools/2.2.3/css/dataTables.tableTools.css\">\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"css/select2/select2.min.css.gz\">\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"css/select2/select2-bootstrap.min.css.gz\">\n        \n        <script type=\"text/javascript\" charset=\"utf8\" src=\"//cdn.datatables.net/1.10.0/js/jquery.dataTables.js\"></script>\n        <script type=\"text/javascript\" charset=\"utf8\" src=\"//cdn.datatables.net/tabletools/2.2.3/js/dataTables.tableTools.min.js\"></script>\n        <script src=\"js/select2.min.js.gz\"></script>\n        <script src=\"js/mustache.min.js.gz\"></script>\n        \n        <meta name=\"cjsSaveMode\" content=\"auto\">\n    </head>\n    \n    <body>\n        <div class=\"container study\">\n            <div class=\"row\">\n                <h2>Emovera Study</h2>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <div id=\"study-form\" class=\"form-group\">\n                    <label for=\"study\" class=\"control-label col-xs-2 col-sm-2 col-md-2 col-lg-2\">Study Name</label>\n                    <div class=\"col-xs-8 col-sm-8 col-md-8 col-lg-8\">\n                        <input type=\"text\" class=\"form-control\" id=\"study\" placeholder=\"Enter the study name\" data-bind=\"value: study\">\n                        <span class=\"help-block\" data-bind=\"visible:studyError\">Study name cannot be null</span>\n                    </div>\n                </div>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <h3 class=\"inline\">Topics for the Study</h3>\n                <button  type=\"button\" class=\"btn btn-success\" data-bind=\"click: addTopic\">\n                        Add Topic\n                </button>\n            </div>\n            <div class=\"topic\" data-bind=\"foreach: topics\">\n                <div class=\"row\">\n                    <div class=\"col-xs-6 col-sm-6 col-md-6 col-lg-6\">\n                        <input type=\"text\" class=\"form-control\" data-bind=\"value: topic\"> \n                    </div>\n                    <div class=\"col-xs-1 col-sm-1 col-md-1 col-lg-1\">\n                        <a href=\"#\" data-bind=\"click: $parent.deleteTopic\"><i class=\"fa fa-trash-o fa-lg\"></i></a>\n                    </div>\n                </div>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <h3 class=\"inline\">Emails for the Study</h3>\n                <button  type=\"button\" class=\"btn btn-success\" data-bind=\"click: addEmail\">\n                        Add Email\n                </button>\n            </div>\n            <div class=\"email\" data-bind=\"foreach: emails\">\n                <div class=\"row\">\n                    <div class=\"col-xs-6 col-sm-6 col-md-6 col-lg-6\">\n                        <input type=\"text\" class=\"form-control\" data-bind=\"value: email\"> \n                    </div>\n                    <div class=\"col-xs-1 col-sm-1 col-md-1 col-lg-1\">\n                        <a href=\"#\" data-bind=\"click: $parent.deleteEmail\"><i class=\"fa fa-trash-o fa-lg\"></i></a>\n                    </div>\n                </div>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <form>\n                    <div class=\"row form-group\">\n                        <label for=\"templates\" class=\"control-label col-xs-2 col-sm-2 col-md-2 col-lg-2\">Email Template</label>\n                        <div class=\"col-xs-8 col-sm-8 col-md-8 col-lg-8\">\n                            <input type=\"hidden\" class=\"form-control\" id=\"templates\" placeholder=\"Templates\">\n                        </div>\n                    </div>\n                    <div id=\"email-template-form\" class=\"row form-group\">\n                        <label for=\"duetime\" class=\"control-label col-xs-2 col-sm-2 col-md-2 col-lg-2\">Due Time</label>\n                        <div class=\"col-xs-8 col-sm-8 col-md-8 col-lg-8\">\n                            <input type=\"text\" class=\"form-control\" id=\"duetime\" placeholder=\"Enter due time\" data-bind=\"value: duetime\">\n                            <span class=\"help-block\" data-bind=\"visible:dueTimeError\">Due time cannot be null</span>\n                        </div>\n                    </div>\n                    <button  type=\"button\" class=\"btn btn-success\" data-bind=\"click: generate\" style=\"margin-top: 20px;margin-left: 0px;\">\n                            Generate Topics&nbsp;<i data-bind=\"visible: generateinprocess\" class=\"fa fa-spinner fa-spin\"></i>\n                    </button>\n                </form>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <h3>Results</h3>\n            </div>\n            <div class=\"row\">\n                <div class=\"divider\"></div>\n            </div>\n            <div class=\"row\">\n                <table id=\"myTable\" class=\"display\">\n                    <thead>\n                        <tr>\n                            <th>Email</th>\n                            <th>Topic</th>\n                            <th>Link</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n        \n        <script>\n            var table;\n        \n            function TopicVM(){\n                var self = this;\n                \n                this.email = ko.observable();\n                this.topic = ko.observable();\n                this.link = ko.observable();\n            }\n            function StudyVM(){\n                var self = this;\n                \n                this.study = ko.observable();\n                this.studyError = ko.observable(false);\n                \n                this.duetime = ko.observable();\n                this.dueTimeError = ko.observable(false);\n                this.templateName = ko.observable();\n                \n                this.generateinprocess = ko.observable(false);\n                \n                this.emailClient = new $cjs.email.Client(\"MANDRILL\", {\"apiKey\": \"OXcdWVBVVOI5wosX5S5xGw\"});\n                \n                this.validateStudyName = function(value){\n                    if (!value || !value.trim()){\n                        $('#study-form').addClass(\"has-error\");\n                        self.studyError(true);\n                    }else{\n                        $('#study-form').removeClass(\"has-error\");\n                        self.studyError(false);\n                    }\n                }\n                \n                this.validateEmailTemplate = function(){\n                    if (!self.duetime() || !self.duetime().trim()){\n                        $('#email-template-form').addClass(\"has-error\");\n                        self.dueTimeError(true);\n                        \n                        return false;\n                    }else{\n                        $('#email-template-form').removeClass(\"has-error\");\n                        self.dueTimeError(false);\n                        \n                        return true;\n                    }\n                }\n                \n                this.study.subscribe(function(newValue){\n                    self.validateStudyName(newValue);\n                })\n                \n                this.topics = ko.observableArray([]);\n                this.emails = ko.observableArray([]);\n                this.results = ko.observableArray([]);\n                \n                this.addTopic = function(){\n                    self.topics.push(new TopicVM());\n                }\n                \n                this.deleteTopic = function(){\n                    self.topics.remove(this);\n                }\n                \n                this.addEmail = function(){\n                    self.emails.push(new TopicVM());\n                }\n                \n                this.deleteEmail = function(){\n                    self.emails.remove(this);\n                }\n                \n                this.sendEmail = function(email, links, paramStr){\n                    var renderParams = {\n                        EMAIL: email,\n                        DUETIME: self.duetime()\n                    }\n                    _.each(links, function(x, index, list){\n                        renderParams[\"LINK\"+(index+1)] = x;\n                    });\n\n                    var paramObj = JSON.parse(Mustache.render(paramStr, renderParams));\n                    self.emailClient.messages.sendTemplate(paramObj,function(data){\n                        console.log(email + \" is sent!\");\n                    }, function(error1){\n                        console.log(\"send message error for \" + email + \":\"+JSON.stringify(error1));\n                    });\n                }\n                \n                this.generate = function(){\n                    self.validateStudyName(self.study());\n                    \n                    if (!self.validateEmailTemplate()){\n                        return;\n                    }\n                    \n                    if (self.topics().length > 0 && self.emails().length > 0){\n                        self.generateinprocess(true);\n                        var paramStr = \"{\\\"template_name\\\": \\\"\"+self.templateName()+\"\\\",\\\"template_content\\\": [{\\\"name\\\":\\\"Emotion Mining Survey\\\", \\\"content\\\":\\\"Emotion Mining Survey\\\"}],\\\"message\\\" : {\\\"global_merge_vars\\\":[{\\\"name\\\" : \\\"DUETIME\\\",\\\"content\\\" : \\\"{{DUETIME}}\\\"}\";\n                        _.each(self.topics(), function(x, index, list){\n                            paramStr = paramStr + \",{\\\"name\\\" : \\\"LINK\" + (index+1) + \"\\\",\\\"content\\\" : \\\"{{LINK\" + (index+1) + \"}}\\\"}\";\n                        });\n                        paramStr = paramStr + \"],\\\"from_email\\\" : \\\"emci@lambdazen.com\\\",\\\"to\\\": [{\\\"email\\\": \\\"{{EMAIL}}\\\"}],\\\"subject\\\": \\\"Freeform political survey\\\"}}\";\n                        var count = 0;\n                        _.each(self.emails(), function(email){\n                            var links = [];\n                            var topicCounts = 0;\n                            _.each(self.topics(), function(topic){\n                                $cjs('/emci/enterprise/lZJb3CzfA7AHHq1t7pbUfE/').execute('addNewQuestion', [topic.topic(), email.email(), self.study()], \n                                    function(uri){          \n                                        count++;\n                                        topicCounts++;\n                                        var dataRow = [];\n                                        dataRow.push(email.email());\n                                        dataRow.push(topic.topic());\n                                        dataRow.push('<a href=\"https://insights.emotionmining.com/view'+uri+'\">'+'https://insights.emotionmining.com/view'+uri+'</a>');\n                                        table.row.add(dataRow);\n                                        table.draw();\n                                        \n                                        links.push(\"https://insights.emotionmining.com/view\"+uri);\n                                        if (topicCounts == self.topics().length){\n                                            self.sendEmail(email.email(), links, paramStr);\n                                        }\n                                        \n                                        if (count == (self.topics().length * self.emails().length)){\n                                            self.generateinprocess(false);\n                                        }\n                                    },\n                                    function(jqXHR, textStatus, errorThrown){\n                                        console.log(\"execute proxy method addNewQuestion failed, status:\" + textStatus + \", error:\" + errorThrown + \", server response:\" + ((jqXHR.responseText)?jqXHR.responseText:\"\"));\n                                    });\n                            })\n                        });\n                    }\n                }\n            }\n            \n            var studyVM = new StudyVM();\n            ko.applyBindings(studyVM);\n            \n            $(function () {\n                table = $('#myTable').DataTable( {\n                    \"order\": [[0, \"asc\"]],\n                     \"dom\": 'T<\"clear\">lfrtip',\n                    \"tableTools\": {\n                        \"sSwfPath\": \"//cdn.datatables.net/tabletools/2.2.3/swf/copy_csv_xls_pdf.swf\",\n                        \"aButtons\": [\n                        {'sExtends':'copy',\n                            \"oSelectorOpts\": { filter: 'applied', order: 'current' }\n                        },\n                        {'sExtends':'csv',\n                            \"oSelectorOpts\": { filter: 'applied', order: 'current' }\n                        },\n                        {'sExtends':'xls',\n                            \"oSelectorOpts\": { filter: 'applied', order: 'current' }\n                        },\n                        {'sExtends':'pdf',\n                            \"oSelectorOpts\": { filter: 'applied', order: 'current' }\n                        },\n                        {'sExtends':'print',\n                            \"oSelectorOpts\": { filter: 'applied', order: 'current' }\n                        }]\n                    }\n                    \n                });\n                \n                studyVM.emailClient.templates.list({}, function(data){\n                    $(\"#templates\").select2({\n                        data: _.map(data, function(x, index, list){\n                            return { \"id\" : x.name, \"text\": x.name };\n                        }),\n                        width: '350px'\n                    }).on(\"change\", function(e) {\n                        studyVM.templateName($(\"#templates\").val());\n                    });\n                    \n                    $(\"#templates\").select2(\"val\",(data[0].name), true);\n                },function(error){\n                    console.log(\"list email templates error:\"+JSON.stringify(error));\n                });\n                \n                $(\"#duetime\").val(\"before noon on Saturday, February 6\");\n            });\n        </script>\n    </body>\n</html>",
      "strEditMode" : "html",
      "type" : "STRING"
    }
  }, {
    "name" : "page",
    "expr" : {
      "concept" : "/common/core/iduwOQ2KZv8MWqamwqb6AE/",
      "bindings" : {
        "html" : "htmlTemplate"
      },
      "type" : "CONCEPT"
    }
  } ],
  "isas" : [ {
    "var" : "page"
  } ],
  "encodedidxhash" : "",
  "isLambda" : false
}